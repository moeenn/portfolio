---
import fs from "node:fs";
import BaseLayout from "../layouts/BaseLayout.astro";
import Container from "../components/Container.astro";
import SectionHeading from "../components/SectionHeading.astro";
import BlogPostCard from "../components/BlogPostCard.astro";
import { getCollection } from "astro:content";
const blogposts = await getCollection("blog");

const categories = new Set(blogposts.map((p) => p.data.category));
const tags = new Set(blogposts.flatMap((p) => p.data.tags));
const sorted = (items: Set<string>) => [...items.keys()].sort();
---

<BaseLayout
	title="Blogs"
	meta={{
		url: "/blogs",
		description:
			"Technical articles and musings related to software engineering",
	}}
>
	<Container>
		<section class="pt-8 pb-14">
			<SectionHeading text="Blogs" />

			<div class="grid grid-cols-1 xl:grid-cols-4">
				<div class="xl:pl-6 xl:h-full xl:order-last">
					<div class="xl:sticky xl:top-4">
						<div>
							<div class="pb-2 flex justify-between">
								<p class="text-xs font-medium text-gray-600">
									Categories
								</p>

								<button
									hidden
									data-clear-categories
									title="Clear selected categories"
									class="cursor-pointer text-xs text-red-700 hover:underline"
									>Clear
								</button>
							</div>

							<div class="flex flex-wrap gap-2">
								{
									sorted(categories)
										.sort()
										.map((c) => (
											<span
												data-category={c}
												class="cursor-pointer text-xs text-gray-800 bg-gray-200 hover:bg-gray-300 hover:text-black transition-colors px-3 py-1 rounded"
											>
												{c}
											</span>
										))
								}
							</div>
						</div>

						<div class="mt-10 mb-12">
							<div class="pb-2 flex justify-between">
								<p class="text-xs font-medium text-gray-600">
									Tags
								</p>

								<button
									hidden
									data-clear-tags
									title="Clear selected tags"
									class="cursor-pointer text-xs text-red-700 hover:underline"
									>Clear
								</button>
							</div>
							<div class="flex flex-wrap gap-2">
								{
									sorted(tags).map((t) => (
										<span
											data-tag={t}
											class="cursor-pointer text-xs text-gray-800 bg-gray-200 hover:bg-gray-300 hover:text-black transition-colors px-3 py-1 rounded"
										>
											{t}
										</span>
									))
								}
							</div>
						</div>
					</div>
				</div>

				<div
					class="col-span-1 xl:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6 xl:order-first"
				>
					{
						blogposts
							.sort((a, b) => {
								const aModified = new Date(
									fs.statSync(a.filePath ?? "").mtime,
								);
								const bModified = new Date(
									fs.statSync(b.filePath ?? "").mtime,
								);
								return (
									bModified.valueOf() - aModified.valueOf()
								);
							})
							.map((p) => <BlogPostCard post={p} />)
					}
				</div>
			</div>
		</section>

		<script is:inline src="/scripts/blogFilter.js"></script>
	</Container>
</BaseLayout>
